<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagefind Integration Test Suite</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #0056b3; }
        .test-button:disabled { background: #6c757d; cursor: not-allowed; }
        #test-output { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .search-test { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .search-input { width: 300px; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 3px; }
        .search-results { margin: 10px 0; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px; min-height: 100px; }
    </style>
</head>
<body>
    <h1>üîç Pagefind Integration Test Suite</h1>
    <p><strong>Test Context:</strong> This page tests Pagefind integration. Some tests may fail on this standalone page - this is expected! For full testing, use the "üè† Test Main Site" button.</p>
    <p>This test suite validates our Pagefind search integration functionality.</p>

    <div class="test-section">
        <h2>üß™ Test Controls</h2>
        <button class="test-button" onclick="runAllTests()">üöÄ Run All Tests</button>
        <button class="test-button" onclick="clearResults()">üßπ Clear Results</button>
        <button class="test-button" onclick="testPagefindScripts()">üìú Test Pagefind Scripts</button>
        <button class="test-button" onclick="testSearchModal()">üîç Test Search Modal</button>
        <button class="test-button" onclick="testPagefindAPI()">‚ö° Test Pagefind API</button>
        <button class="test-button" onclick="testParagraphSearch()">üìù Test Paragraph Search</button>
        <button class="test-button" onclick="testAnchorNavigation()">üîó Test Anchor Navigation</button>
        <button class="test-button" onclick="testMainSite()">üè† Test Main Site</button>
    </div>

    <div class="search-test">
        <h3>üîç Live Search Test</h3>
        <input type="text" class="search-input" id="live-search-input" placeholder="Type to test search..." oninput="testLiveSearch(this.value)">
        <div class="search-results" id="live-search-results">
            <em>Type above to test live search functionality...</em>
        </div>
    </div>

    <div id="test-output"></div>

    <script>
        let testResults = [];
        let pagefindAPI = null;

        // Test result logging
        function logTest(testName, result, details = '') {
            const status = result ? 'PASS' : 'FAIL';
            const cssClass = result ? 'pass' : 'fail';
            
            const testResult = {
                name: testName,
                status: status,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(testResult);
            
            const output = document.getElementById('test-output');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${cssClass}`;
            resultDiv.innerHTML = `
                <strong>${status}:</strong> ${testName}
                ${details ? `<br><small>${details}</small>` : ''}
                <br><small>${testResult.timestamp}</small>
            `;
            output.appendChild(resultDiv);
            
            console.log(`${status}: ${testName}`, details);
        }

        // Clear test results
        function clearResults() {
            document.getElementById('test-output').innerHTML = '';
            testResults = [];
            console.log('üßπ Test results cleared');
        }

        // Test 1: Pagefind Scripts Loading
        async function testPagefindScripts() {
            logTest('Pagefind Scripts Loading', true, 'Starting script loading tests...');
            
            // Test Pagefind UI script - this will only work on main site
            if (typeof PagefindUI !== 'undefined') {
                logTest('PagefindUI Global Available', true, 'PagefindUI is globally accessible');
            } else {
                logTest('PagefindUI Global Available', false, 'PagefindUI not found in global scope (expected on test page)');
            }

            // Test Pagefind core script - this should work everywhere
            try {
                const pagefind = await import('/pagefind/pagefind.js');
                if (pagefind && typeof pagefind.search === 'function') {
                    logTest('Pagefind Core Script', true, 'Pagefind core script loaded successfully');
                    pagefindAPI = pagefind;
                } else {
                    logTest('Pagefind Core Script', false, 'Pagefind core script missing search function');
                }
            } catch (error) {
                logTest('Pagefind Core Script', false, `Failed to load Pagefind core: ${error.message}`);
                logTest('Core Script Context', true, 'This may be expected if Pagefind is not fully configured');
            }

            // Test Pagefind highlight script - this should work everywhere
            try {
                const highlight = await import('/pagefind/pagefind-highlight.js');
                if (highlight && (typeof highlight.default === 'function' || typeof highlight.PagefindHighlight === 'function')) {
                    logTest('Pagefind Highlight Script', true, 'Pagefind highlight script loaded successfully');
                } else {
                    logTest('Pagefind Highlight Script', false, 'Pagefind highlight script missing expected exports');
                }
            } catch (error) {
                logTest('Pagefind Highlight Script', false, `Failed to load Pagefind highlight: ${error.message}`);
            }
            
            // Check if we're on main site or test page
            const isMainSite = window.location.pathname === '/' || 
                              window.location.pathname.includes('.html') ||
                              window.location.pathname.includes('heists') ||
                              window.location.pathname.includes('about');
            
            if (isMainSite) {
                logTest('Test Context', true, 'Running on main site - PagefindUI should be available');
            } else {
                logTest('Test Context', true, 'Running on test page - PagefindUI not expected, but core scripts should work');
            }
        }

        // Test 2: Search Modal Functionality
        function testSearchModal() {
            logTest('Search Modal Tests', true, 'Starting modal functionality tests...');
            
            // Check if we're on a main site page or standalone test page
            const isMainSite = window.location.pathname === '/' || 
                              window.location.pathname.includes('.html') ||
                              window.location.pathname.includes('heists') ||
                              window.location.pathname.includes('about');
            
            if (!isMainSite) {
                logTest('Search Modal Elements', true, 'Skipping modal tests on standalone test page - no search elements expected');
                logTest('Modal Test Context', true, 'For full search modal tests, visit: http://localhost:8000/');
                return;
            }
            
            // Test if search overlay exists
            const searchOverlay = document.getElementById('search-overlay');
            if (searchOverlay) {
                logTest('Search Overlay Element', true, 'Search overlay element found');
            } else {
                logTest('Search Overlay Element', false, 'Search overlay element not found');
            }

            // Test if search input exists
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                logTest('Search Input Element', true, 'Search input element found');
            } else {
                logTest('Search Input Element', false, 'Search input element not found');
            }

            // Test if search close button exists
            const searchClose = document.getElementById('search-close');
            if (searchClose) {
                logTest('Search Close Button', true, 'Search close button found');
            } else {
                logTest('Search Close Button', false, 'Search close button not found');
            }

            // Test if search results container exists
            const searchResults = document.getElementById('search-results');
            if (searchResults) {
                logTest('Search Results Container', true, 'Search results container found');
            } else {
                logTest('Search Results Container', false, 'Search results container not found');
            }

            // Test search icons
            const searchIcons = document.querySelectorAll('.search-icon');
            if (searchIcons.length > 0) {
                logTest('Search Icons', true, `Found ${searchIcons.length} search icon(s)`);
            } else {
                logTest('Search Icons', false, 'No search icons found');
            }

            // Test if we can simulate search result display
            if (searchResults && searchInput) {
                // Test if the search input has event listeners
                const inputEvents = getEventListeners(searchInput);
                if (inputEvents && inputEvents.input) {
                    logTest('Search Input Events', true, 'Search input has event listeners attached');
                } else {
                    logTest('Search Input Events', false, 'Search input missing event listeners');
                }
            }
        }

        // Helper function to check event listeners (simplified)
        function getEventListeners(element) {
            // This is a simplified check - in real browsers you'd need dev tools
            return {
                input: element.oninput !== null || element.addEventListener !== undefined
            };
        }

        // Test 3: Pagefind API Functionality
        async function testPagefindAPI() {
            logTest('Pagefind API Tests', true, 'Starting API functionality tests...');
            
            if (!pagefindAPI) {
                logTest('Pagefind API Available', false, 'Pagefind API not loaded - this is expected on test page');
                logTest('API Test Context', true, 'For full API tests, visit main site or ensure Pagefind core script loads');
                return;
            }

            try {
                // Test basic search
                const results = await pagefindAPI.search('test');
                
                if (results && results.results) {
                    logTest('Pagefind Search Function', true, `Search returned ${results.results.length} results`);
                    
                    // Test result structure
                    if (results.results.length > 0) {
                        const firstResult = results.results[0];
                        logTest('Result Structure', true, `First result has ${Object.keys(firstResult).length} properties`);
                        
                        // Test if data function exists
                        if (typeof firstResult.data === 'function') {
                            logTest('Result Data Function', true, 'Result data function is callable');
                            
                            // Test data extraction
                            try {
                                const resultData = await firstResult.data();
                                if (resultData && typeof resultData === 'object') {
                                    logTest('Data Extraction', true, `Extracted data with ${Object.keys(resultData).length} properties`);
                                    
                                    // Test specific data fields
                                    if (resultData.title) {
                                        logTest('Title Extraction', true, `Title: "${resultData.title.substring(0, 50)}..."`);
                                    } else {
                                        logTest('Title Extraction', false, 'No title found in extracted data');
                                    }
                                    
                                    if (resultData.url) {
                                        logTest('URL Extraction', true, `URL: ${resultData.url}`);
                                    } else {
                                        logTest('URL Extraction', false, 'No URL found in extracted data');
                                    }
                                } else {
                                    logTest('Data Extraction', false, 'Extracted data is not an object');
                                }
                            } catch (error) {
                                logTest('Data Extraction', false, `Error extracting data: ${error.message}`);
                            }
                        } else {
                            logTest('Result Data Function', false, 'Result data is not a function');
                        }
                    } else {
                        logTest('Result Structure', false, 'No results to test structure');
                    }
                } else {
                    logTest('Pagefind Search Function', false, 'Search did not return expected results structure');
                }
            } catch (error) {
                logTest('Pagefind API Tests', false, `API test failed: ${error.message}`);
            }
        }

        // Test 4: Live Search Testing
        async function testLiveSearch(query) {
            if (!query || query.length < 2) {
                document.getElementById('live-search-results').innerHTML = '<em>Type at least 2 characters to test search...</em>';
                return;
            }

            if (!pagefindAPI) {
                document.getElementById('live-search-results').innerHTML = '<em>Pagefind API not loaded. Run script tests first.</em>';
                return;
            }

            try {
                const results = await pagefindAPI.search(query);
                const resultsDiv = document.getElementById('live-search-results');
                
                if (results && results.results && results.results.length > 0) {
                    let resultsHTML = `<h4>Search Results for "${query}" (${results.results.length} found):</h4>`;
                    
                    for (let i = 0; i < Math.min(results.results.length, 5); i++) {
                        const result = results.results[i];
                        try {
                            const resultData = await result.data();
                            const title = resultData.title || 'Untitled';
                            const url = resultData.url || '#';
                            const excerpt = resultData.excerpt || 'No excerpt available';
                            
                            resultsHTML += `
                                <div style="margin: 10px 0; padding: 10px; border: 1px solid #eee; border-radius: 3px;">
                                    <strong>${title}</strong><br>
                                    <small>URL: ${url}</small><br>
                                    <em>${excerpt.substring(0, 100)}...</em>
                                </div>
                            `;
                        } catch (error) {
                            resultsHTML += `
                                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ffcccc; border-radius: 3px; color: #cc0000;">
                                    <strong>Error extracting result ${i + 1}:</strong> ${error.message}
                                </div>
                            `;
                        }
                    }
                    
                    resultsDiv.innerHTML = resultsHTML;
                } else {
                    resultsDiv.innerHTML = `<em>No results found for "${query}"</em>`;
                }
            } catch (error) {
                document.getElementById('live-search-results').innerHTML = `<em>Search error: ${error.message}</em>`;
            }
        }

        // Test 5: Paragraph-Level Search Testing
        async function testParagraphSearch() {
            logTest('Paragraph Search Test', true, 'Testing paragraph-level search functionality...');
            
            if (!pagefindAPI) {
                logTest('Paragraph Search API', false, 'Pagefind API not loaded. Run script tests first.');
                return;
            }

            try {
                // Test search for content that should return paragraph-level results
                const testQueries = ['creativity', 'novelty', 'startup ideas', 'entrepreneur'];
                let paragraphResultsFound = false;
                
                for (const query of testQueries) {
                    try {
                        const results = await pagefindAPI.search(query);
                        
                        if (results && results.results && results.results.length > 0) {
                            logTest(`Search Query: "${query}"`, true, `Found ${results.results.length} results`);
                            
                            // Check for paragraph-level results (results with anchor information)
                            for (const result of results.results) {
                                if (result.anchor) {
                                    paragraphResultsFound = true;
                                    logTest('Paragraph Result Found', true, 
                                        `Found paragraph result: "${result.anchor.title || 'Untitled'}" in ${result.url || 'unknown page'}`);
                                    
                                    // Test anchor data structure
                                    if (result.anchor.id) {
                                        logTest('Anchor ID', true, `Anchor ID: ${result.anchor.id}`);
                                    } else {
                                        logTest('Anchor ID', false, 'No anchor ID found');
                                    }
                                    
                                    if (result.anchor.title) {
                                        logTest('Anchor Title', true, `Anchor title: ${result.anchor.title}`);
                                    } else {
                                        logTest('Anchor Title', false, 'No anchor title found');
                                    }
                                    
                                    break; // Found a paragraph result, no need to check more
                                }
                            }
                        } else {
                            logTest(`Search Query: "${query}"`, false, 'No results found');
                        }
                    } catch (error) {
                        logTest(`Search Query: "${query}"`, false, `Search failed: ${error.message}`);
                    }
                }
                
                if (paragraphResultsFound) {
                    logTest('Paragraph Search Summary', true, 'Successfully found paragraph-level search results');
                } else {
                    logTest('Paragraph Search Summary', false, 'No paragraph-level results found. Check if Pagefind index includes paragraph data.');
                }
                
            } catch (error) {
                logTest('Paragraph Search Test', false, `Test failed: ${error.message}`);
            }
        }

        // Test 6: Anchor Navigation Testing
        async function testAnchorNavigation() {
            logTest('Anchor Navigation Test', true, 'Testing anchor navigation and highlighting...');
            
            if (!pagefindAPI) {
                logTest('Anchor Navigation API', false, 'Pagefind API not loaded. Run script tests first.');
                return;
            }

            try {
                // Test search for specific content that should have anchors
                const results = await pagefindAPI.search('creativity');
                
                if (results && results.results && results.results.length > 0) {
                    logTest('Anchor Search Results', true, `Found ${results.results.length} results for "creativity"`);
                    
                    // Find a result with anchor information
                    let anchorResult = null;
                    for (const result of results.results) {
                        if (result.anchor) {
                            anchorResult = result;
                            break;
                        }
                    }
                    
                    if (anchorResult) {
                        logTest('Anchor Result Found', true, 
                            `Found anchor result: "${anchorResult.anchor.title || 'Untitled'}"`);
                        
                        // Test URL generation with anchor
                        const baseUrl = anchorResult.url || '';
                        const anchorId = anchorResult.anchor.id || '';
                        
                        if (baseUrl && anchorId) {
                            const anchorUrl = `${baseUrl}#${anchorId}`;
                            logTest('Anchor URL Generation', true, `Generated anchor URL: ${anchorUrl}`);
                            
                            // Test if we can construct a valid navigation link
                            try {
                                const testLink = document.createElement('a');
                                testLink.href = anchorUrl;
                                logTest('Anchor Link Creation', true, `Created valid anchor link: ${testLink.href}`);
                            } catch (error) {
                                logTest('Anchor Link Creation', false, `Failed to create anchor link: ${error.message}`);
                            }
                        } else {
                            logTest('Anchor URL Generation', false, 'Missing base URL or anchor ID');
                        }
                        
                        // Test highlight script availability
                        try {
                            const highlight = await import('/pagefind/pagefind-highlight.js');
                            if (highlight && typeof highlight.default === 'function') {
                                logTest('Highlight Script Available', true, 'Pagefind highlight script is accessible');
                            } else {
                                logTest('Highlight Script Available', false, 'Highlight script not properly loaded');
                            }
                        } catch (error) {
                            logTest('Highlight Script Available', false, `Failed to load highlight script: ${error.message}`);
                        }
                        
                    } else {
                        logTest('Anchor Result Found', false, 'No results with anchor information found');
                    }
                } else {
                    logTest('Anchor Search Results', false, 'No search results found for testing');
                }
                
            } catch (error) {
                logTest('Anchor Navigation Test', false, `Test failed: ${error.message}`);
            }
        }

        // Test 7: Main Site Functionality
        function testMainSite() {
            logTest('Main Site Test', true, 'Testing main site functionality...');
            
            // Open main site in new tab for testing
            const mainSiteUrl = 'http://localhost:8000/';
            logTest('Main Site URL', true, `Opening main site: ${mainSiteUrl}`);
            
            // Try to open in new tab
            try {
                window.open(mainSiteUrl, '_blank');
                logTest('Main Site Access', true, 'Main site opened in new tab. Test search functionality there.');
            } catch (error) {
                logTest('Main Site Access', false, `Failed to open main site: ${error.message}`);
            }
            
            // Provide instructions
            logTest('Main Site Instructions', true, 'On main site: 1) Click search icon 2) Type "creativity" or "novelty" 3) Look for üìé paragraph results 4) Click a paragraph result to test anchor navigation');
        }

        // Run all tests
        async function runAllTests() {
            clearResults();
            logTest('Test Suite Started', true, 'Running comprehensive Pagefind integration tests...');
            
            await testPagefindScripts();
            testSearchModal();
            await testPagefindAPI();
            await testParagraphSearch();
            await testAnchorNavigation();
            
            logTest('Test Suite Complete', true, `All tests completed. ${testResults.filter(r => r.status === 'PASS').length}/${testResults.length} tests passed.`);
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', async () => {
            logTest('Page Loaded', true, 'Test page loaded successfully');
            await testPagefindScripts();
            // Only test search modal if we're on main site
            if (window.location.pathname === '/' || 
                window.location.pathname.includes('.html') ||
                window.location.pathname.includes('heists') ||
                window.location.pathname.includes('about')) {
                testSearchModal();
            }
        });
    </script>
</body>
</html>
